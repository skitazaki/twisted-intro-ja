
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>パート7: Deferred 入門 &#8212; Twisted Intro</title>
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="パート8: Deferred で詩を" href="p08.html" />
    <link rel="prev" title="パート6: さらなる高みへ" href="p06.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Twisted Intro</span></a></h1>
        <h2 class="heading"><span>パート7: Deferred 入門</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="p06.html">パート6: さらなる高みへ</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="p08.html">パート8: Deferred で詩を</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <div class="section" id="deferred">
<h1>パート7: Deferred 入門<a class="headerlink" href="#deferred" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>コールバックとその結果<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>“<a class="reference internal" href="p06.html"><span class="doc">パート6: さらなる高みへ</span></a>”では、次の事実にたどり着きました。コールバックは非同期プログラミングの基礎を成すのです。reactor と向き合う方法というだけでなく、コールバックは私たちが書くどのような Twisted プログラムの構成でも編み込みます。Twisted やどのような reactor ベースの非同期システムを使うときも、私たちのコードを特定の方法で構成しておくことを意味します。reactor ループが呼び出す一連のコールバック・チェーンとして、です。</p>
<p><a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry-1.py#L81">get_poetry</a> 関数くらい簡単な API でさえも二つのコールバックを要求します。ひとつは通常の結果に対してのもの、もうひとつはエラーに対してのものです。Twisted プログラマとしてはこれらをできる限り使いこなせるようにならなくてはいけませんので、コールバックの最も良い使い方や、これから出くわすかもしれない落とし穴について考えることに少しは時間を割くべきでしょう。</p>
<p>クライアント 3.1 から持ってきた <code class="docutils literal notranslate"><span class="pre">get_poetry</span></code> の Twisted バージョンについて考えてみましょう。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="k">def</span> <span class="nf">got_poem</span><span class="p">(</span><span class="n">poem</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">poem</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">poem_failed</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;poem download failed&#39;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;I am terribly sorry&#39;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;try again later?&#39;</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">get_poetry</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">got_poem</span><span class="p">,</span> <span class="n">poem_failed</span><span class="p">)</span>

<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>ここでの基本的な考え方は明らかですね。</p>
<ol class="arabic simple">
<li><p>詩を取得したら、出力しなさい。</p></li>
<li><p>詩を取得できなかったら、エラーの俳句を出力しなさい。</p></li>
<li><p>どちらの場合もプログラムを停止しなさい。</p></li>
</ol>
<p>上記の同期版はこんな感じでしょうか。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">poem</span> <span class="o">=</span> <span class="n">get_poetry</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="c1"># the synchronous version of get_poetry</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;poem download failed&#39;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;I am terribly sorry&#39;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;try again later?&#39;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span> <span class="n">poem</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>
</div>
<p>コールバックは <code class="docutils literal notranslate"><span class="pre">else</span></code> 節でエラー用コールバックは <code class="docutils literal notranslate"><span class="pre">except</span></code> のようなものです。エラー用のコールバック呼び出しは非同期においては例外を発生させることで、通常のコールバックは普通の制御フローに相当します。</p>
<p>この二つのバージョンの違いは何でしょう？ひとつは、同期バージョンでは Python インタープリタが次のことを保証します。 <code class="docutils literal notranslate"><span class="pre">get_poetry</span></code> がいかなる理由でどのような種類の例外を発生させようとも、 <code class="docutils literal notranslate"><span class="pre">except</span></code> ブロックは実行されます。インタープリタが Python のコードを正確に実行してくれると信じるなら、エラーブロックは適切な時に実行されるでしょう。</p>
<p>非同期バージョンと対比してみましょう。 <code class="docutils literal notranslate"><span class="pre">poem_failed</span></code> というエラー用コールバックは “私たちの” コードから呼ばれます。 <a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry-1.py#L66">PoetryClientFactory</a> の <a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry-1.py#L77">clientConnectionFailed</a> メソッドです。何かがおかしくなったときにエラーコードを確実に実行させるのは、Python ではなく、私たちの責任です。このため、 <code class="docutils literal notranslate"><span class="pre">Failure</span></code> オブジェクトを伴ったエラー用コールバックを呼び出すときは、考えられるあらゆるエラーケースを扱えるようにしなくてはなりません。さもなくば、プログラムは決して辿りつくことのないコールバックを待ってスタックしてしまいます。</p>
<p>このことは、同期と非同期のもう一つの違いを表しています。もしも非同期バージョンで例外をキャッチしていなければ (<code class="docutils literal notranslate"><span class="pre">try/except</span></code> を使わないで)、Python インタープリタがそれをキャッチしてエラーを表示して終了していたことでしょう。しかし、 <code class="docutils literal notranslate"><span class="pre">PoetryClientFactory</span></code> でエラー用コールバックの呼び出しを面倒がって省略していたら、私たちのプログラムは延々と動作し続けるでしょう。さも何も起こっていないかのように。</p>
<p>明らかに非同期プログラムにおけるエラーの扱いは重要であり、いくらかトリッキーです。非同期コードでエラーを処理することは実は通常の場合を扱うよりも大事かもしれません。うまくいくときより遥かに明後日の方向に行ってしまうからです。エラー処理を忘れることは、Twisted を使ったプログラミングでのよくある間違いです。</p>
<p>上記の同期版のコードに関するもうひとつの事実もあります。 <code class="docutils literal notranslate"><span class="pre">else</span></code> ブロックがただ一度だけ実行されるか、 <code class="docutils literal notranslate"><span class="pre">except</span></code> ブロックがただ一度だけ実行されるかのどちらかです (同期版の <code class="docutils literal notranslate"><span class="pre">get_poetry</span></code> は無限ループに陥らないと考えておいてください)。Python インタープリタはそれらの両方を実行するのか <code class="docutils literal notranslate"><span class="pre">else</span></code> ブロックを27回実行するのか、すぐには決めません。基本的に Python のプログラムでそうすることは不可能です。</p>
<p>しかし、私たちがコールバックかエラー用コールバックを実行させる責任を負っている、非同期の場合についてもう一度考えてみましょう。お気づきかもしれませんが、いくつかの間違いを犯しているかもしれません。コールバックとエラー用コールバックの両方を呼び出すこともできましたし、コールバックだけを27回呼び出すこともできました。これは <code class="docutils literal notranslate"><span class="pre">get_poetry</span></code> を使う人には不幸な結果になってしまいます。docstring は明示的に述べていませんが、次のことは言わずに実際には実行されてしまうのです。 <code class="docutils literal notranslate"><span class="pre">try/except</span></code> 節にある <code class="docutils literal notranslate"><span class="pre">else</span></code> と <code class="docutils literal notranslate"><span class="pre">except</span></code> ブロックのように、 <code class="docutils literal notranslate"><span class="pre">get_poetry</span></code> のそれぞれの呼び出しにおいて、コールバックがただ一度だけ実行されるかエラー用コールバックがただ一度だけ実行されます。詩を受け取るか受け取らないかのどちらかなのです。</p>
<p>三つの詩を要求して7回のコールバック呼び出しと2回のエラー用コールバック呼び出しがあったプログラムをデバッグしようとするところを思い浮かべてください。どこから始めましょうか？おそらくコールバックとエラー用コールバックを、それらが同じ <code class="docutils literal notranslate"><span class="pre">get_poetry</span></code> 呼び出しに対して二回目の呼び出しがあったときを検知し、例外を送出するように書いてみることになるでしょう。 <code class="docutils literal notranslate"><span class="pre">get_poetry</span></code> をそんな感じにしてみましょう。</p>
<p>もう一つ見ておくことがあります。どちらのバージョンもいくつか重複したコードがあります。非同期版は二つの <code class="docutils literal notranslate"><span class="pre">reactor.stop</span></code> 呼び出しがあり、同期版は <code class="docutils literal notranslate"><span class="pre">sys.exit</span></code> があります。同期版はこんな感じでリファクタリングしましょうか。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">poem</span> <span class="o">=</span> <span class="n">get_poetry</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="c1"># the synchronous version of get_poetry</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;poem download failed&#39;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;I am terribly sorry&#39;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;try again later?&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span> <span class="n">poem</span>

<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>
</div>
<p>似たような方法で非同期版もリファクタリングできるでしょうか？実ははっきりとはしません。コールバックとエラー用コールバックはふたつの異なる関数だからです。では、単一のコールバックに戻さなくてはいけないのでしょうか？</p>
<p>まぁまぁ。コールバックを使うプログラミングに関して分かってきたことのいくつかとして次のことがあります。</p>
<ol class="arabic simple">
<li><p>エラー用コールバックを呼び出すことは大事です。エラー用コールバックは <code class="docutils literal notranslate"><span class="pre">except</span></code> ブロックの位置を占めますので、ユーザーはそれらをアテにできる必要があります。私たちの API ではオプショナルな機能などではありません。</p></li>
<li><p>間違ったときにコールバックを呼び出さないことは正しいときに呼び出すのと同じように大事です。典型的なユースケースにおいて、コールバックとエラー用コールバックはお互いに排他的でただ一度だけ呼び出されます。</p></li>
<li><p>コールバックを使うと、一般的なコードのリファクタリングも難しくなるかもしれません。</p></li>
</ol>
<p>後々のパートでコールバックについてより詳しく説明していきます。しかし、今のところは Twisted にはこうしたことをなんとかするための抽象化がある理由が分かれば十分です。</p>
</div>
<div class="section" id="id2">
<h2>遅延オブジェクト<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>非同期プログラミングではコールバックが多用されますし、それらを正しく使うことはいくらかトリッキーになりえますので、Twisted の開発者はコールバックを使うプログラミングを簡単にするために <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> と呼ばれる抽象化を作りました。 <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> クラスは <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L132">twisted.internet.defer</a> で定義されています。</p>
<blockquote>
<div><p>“deferred” という言葉は今日の英語における動詞か形容詞のどちらかです。名詞として使うのは若干不思議に思われるかもしれません。
ここからは、私が “the deferred” か “a deferred” というフレーズを使うときは、 <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> クラスのインスタンスを指すと考えてください
。なぜそれが <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> と呼ばれるのかを先々のパートでみていきましょう。
“the deferred result” のように、それぞれのフレーズに “result” (結果) という言葉を付け加えてみると理解の助けになるかもしれません。
ときおり見ることになりますが、実際にそれが何であるか、というコトなのです。(訳注：名詞として使う “deferred” は「遅延オブジェクト」、クラス名として使われる “Deferred” はそのままの表記とします。)</p>
</div></blockquote>
<p>遅延オブジェクトはコールバック・チェーンのペアを持ちます。ひとつは通常の結果に対するもので、もうひとつはエラーに対するものです。新しく生成された遅延オブジェクトはふたつの空のチェーンを持ちます。コールバックとエラー用コールバックを付け加えることでチェーンを有効化し、通常の結果 (詩が届いた、ということです) か例外 (詩を得られなかったので、その理由です) のどちらかと一緒に遅延オブジェクトを作動 (訳注：fire) させます。遅延オブジェクトを作動させると、適切なコールバックかエラー用コールバックを、それが追加された順番で呼び出します。図１２は、遅延オブジェクトとそのコールバックとエラー用コールバックを表しています。</p>
<div class="figure align-default" id="id5">
<span id="figure12"></span><img alt="_images/p07_deferred-1.png" src="_images/p07_deferred-1.png" />
<p class="caption"><span class="caption-text">図１２：遅延オブジェクト</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
<p>実際に実装してみましょう。遅延オブジェクトは reactor を使いませんので、ループを開始することなくテストできます。</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">Deferred</span></code> クラスにあり reactor を使う <code class="docutils literal notranslate"><span class="pre">setTimeout</span></code> と呼ばれるメソッドに気付いたかもしれません。それは古い使用で、将来のリリースでは存在しなくなるでしょう。深入りせず、使わないでくださいね。</p>
</div></blockquote>
<p>最初の例は <a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-1.py">twisted-deferred/defer-1.py</a> にあります。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span>

<span class="k">def</span> <span class="nf">got_poem</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s1">&#39;Your poem is served:&#39;</span>
    <span class="nb">print</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">poem_failed</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s1">&#39;No poetry for you.&#39;</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>

<span class="c1"># add a callback/errback pair to the chain</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">got_poem</span><span class="p">,</span> <span class="n">poem_failed</span><span class="p">)</span>

<span class="c1"># fire the chain with a normal result</span>
<span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="s1">&#39;This poem is short.&#39;</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">&quot;Finished&quot;</span>
</pre></div>
</div>
<p>このコードでは新しい遅延オブジェクトを作成し、 <code class="docutils literal notranslate"><span class="pre">addCallbacks</span></code> メソッドによってコールバックとエラー用コールバックのペアを追加し、 <code class="docutils literal notranslate"><span class="pre">callback</span></code> メソッドで通常の結果に対するチェーンを開始させます。もちろん、単一のコールバックしか持ち合わせていませんのでチェーンではありませんが、ここでは問題ではありません。コードを実行させてみると以下の出力を得られるでしょう。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Your</span> <span class="n">poem</span> <span class="ow">is</span> <span class="n">served</span><span class="p">:</span>
<span class="n">This</span> <span class="n">poem</span> <span class="ow">is</span> <span class="n">short</span><span class="o">.</span>
<span class="n">Finished</span>
</pre></div>
</div>
<p>簡単ですね。とはいえ、気をつけるべきことがいくつかあります。</p>
<ol class="arabic simple">
<li><p>クライアント 3.1 で使ったコールバックとエラー用コールバックのペアと同じように、私たちが遅延オブジェクトに付け加えたコールバックはそれぞれひとつの引数を取ります。
通常の結果かエラーの結果のどちらかです。遅延オブジェクトは複数の引数をサポートすることも明らかにしていきますが、いつでも少なくともひとつは必要ですし、最初の引数は通常の結果かエラーのどちらかです。</p></li>
<li><p>遅延オブジェクトにはコールバックとエラー用コールバックをペアにして追加します。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">callback</span></code> メソッドは遅延オブジェクトの通常結果を引き起こします。メソッドの引数がその結果です。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">print</span></code> が出力する順番を見てみると、遅延オブジェクトに合図を送るとすぐにコールバックを呼び出していることが分かります。
非同期に実行されている箇所が見当たりません。reactor が動いていないので当然です。いわゆる Python の関数呼び出しと変わりありません。</p></li>
</ol>
<p>それでは、次に進んでみましょう。 <a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-2.py">twisted-deferred/defer-2.py</a> の例では遅延オブジェクトのエラー用コールバックチェーンを実行させます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span>
<span class="kn">from</span> <span class="nn">twisted.python.failure</span> <span class="kn">import</span> <span class="n">Failure</span>

<span class="k">def</span> <span class="nf">got_poem</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s1">&#39;Your poem is served:&#39;</span>
    <span class="nb">print</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">poem_failed</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s1">&#39;No poetry for you.&#39;</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>

<span class="c1"># add a callback/errback pair to the chain</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">got_poem</span><span class="p">,</span> <span class="n">poem_failed</span><span class="p">)</span>

<span class="c1"># fire the chain with an error result</span>
<span class="n">d</span><span class="o">.</span><span class="n">errback</span><span class="p">(</span><span class="n">Failure</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;I have failed.&#39;</span><span class="p">)))</span>

<span class="nb">print</span> <span class="s2">&quot;Finished&quot;</span>
</pre></div>
</div>
<p>スクリプトを実行してみると以下の出力になるでしょう。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">No</span> <span class="n">poetry</span> <span class="k">for</span> <span class="n">you</span><span class="o">.</span>
<span class="n">Finished</span>
</pre></div>
</div>
<p>エラー用のコールバックチェーンを開始させるには、 <code class="docutils literal notranslate"><span class="pre">callback</span></code> メソッドではなく <code class="docutils literal notranslate"><span class="pre">errback</span></code> メソッドを呼び出し、引数はエラー結果になります。コールバックと同じように、合図があるとすぐに呼び出されます。</p>
<p>先ほどの例ではクライアント 3.1 でそうしたように、 <code class="docutils literal notranslate"><span class="pre">Failure</span></code> オブジェクトを <code class="docutils literal notranslate"><span class="pre">errback</span></code> メソッドに渡しました。これはこれで良いのですが、遅延オブジェクトは <code class="docutils literal notranslate"><span class="pre">Exception</span></code> を <code class="docutils literal notranslate"><span class="pre">Failure</span></code> に変換してくれます。 <a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-3.py">twisted-deferred/defer-3.py</a> を見てください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span>

<span class="k">def</span> <span class="nf">got_poem</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s1">&#39;Your poem is served:&#39;</span>
    <span class="nb">print</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">poem_failed</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">err</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="nb">print</span> <span class="n">err</span>
    <span class="nb">print</span> <span class="s1">&#39;No poetry for you.&#39;</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>

<span class="c1"># add a callback/errback pair to the chain</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">got_poem</span><span class="p">,</span> <span class="n">poem_failed</span><span class="p">)</span>

<span class="c1"># fire the chain with an error result</span>
<span class="n">d</span><span class="o">.</span><span class="n">errback</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;I have failed.&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>ここでは通常の <code class="docutils literal notranslate"><span class="pre">Exception</span></code> を <code class="docutils literal notranslate"><span class="pre">errback</span></code> に渡しています。エラー用コールバックの中で、そのクラスとエラー結果自体を出力します。
こんな出力になります。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>twisted.python.failure.Failure
[Failure instance: Traceback (failure with no frames): : I have failed.
]
No poetry for you.

訳注：処理系またはバージョンによっては &quot;type&quot; が出力されるかもしれません。
::

    twisted.python.failure.Failure
    [Failure instance: Traceback (failure with no frames): &amp;lt;type &#39;exceptions.Excepti
    on&#39;&amp;gt;: I have failed.
    ]
    No poetry for you.
</pre></div>
</div>
<p>このことは、遅延オブジェクトを使うときは元々の <code class="docutils literal notranslate"><span class="pre">Exception</span></code> を扱えば十分であり、 <code class="docutils literal notranslate"><span class="pre">Failure</span></code> は自動的に生成される、ということを意味します。遅延オブジェクトはそれぞれのエラー用コールバックが <code class="docutils literal notranslate"><span class="pre">Failure</span></code> インスタンスと共に呼び出されることを保証してくれるのです。</p>
<p>ここまでで、 <code class="docutils literal notranslate"><span class="pre">callback</span></code> に進んだ場合と <code class="docutils literal notranslate"><span class="pre">errback</span></code> に進んだ場合を見てきました。良きエンジニアがそうであるように、何度も繰り返してみたくなりましたか？コードをより簡潔にするため、 <code class="docutils literal notranslate"><span class="pre">lambda</span></code> を使ってコールバックを追加してみましょう。 <a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-4.py">twisted-deferred/defer-4.py</a> を見てください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span>
<span class="k">def</span> <span class="nf">out</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="nb">print</span> <span class="n">s</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">out</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">out</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="s1">&#39;First result&#39;</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="s1">&#39;Second result&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="s1">&#39;Finished&#39;</span>
</pre></div>
</div>
<p>すると、次の出力を得られます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">First</span> <span class="n">result</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="o">...</span>
<span class="n">twisted</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">defer</span><span class="o">.</span><span class="n">AlreadyCalledError</span>
</pre></div>
</div>
<p>これはおもしろいですね！遅延オブジェクトは正常系のコールバックを二回は呼び出させてくれません。実際のところ、遅延オブジェクトはそれが何であっても二回は呼び出されません。これらの例を実際に見てください。</p>
<ul class="simple">
<li><p><a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-4.py">twisted-deferred-4.py</a></p></li>
<li><p><a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-5.py">twisted-deferred-5.py</a></p></li>
<li><p><a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-6.py">twisted-deferred-6.py</a></p></li>
<li><p><a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-7.py">twisted-deferred-7.py</a></p></li>
</ul>
<p>最後の <code class="docutils literal notranslate"><span class="pre">print</span></code> 文はひとつも呼ばれていないことに注意してください。 <code class="docutils literal notranslate"><span class="pre">callback</span></code> と <code class="docutils literal notranslate"><span class="pre">errback</span></code> メソッドは正真正銘の <code class="docutils literal notranslate"><span class="pre">Exception</span></code> を送出し、その遅延オブジェクトを既に実行したと知らせてくれます。コールバック・プログラミングではよくある落とし穴のひとつです。遅延オブジェクトは、その落とし穴に私たちが落ちてしまわないようにしてくれます。コールバックを管理するために遅延オブジェクトを使うと、コールバックとエラー用コールバックの両方を呼び出してしまう間違いを犯しませんし、コールバックを 27 回も呼び出してしまうこともありません。やってみれば分かりますが、遅延オブジェクトは即座に例外を送出します。誤った呼び出しをコールバック自体に渡してしまうことはありません。</p>
<p>それでは、遅延オブジェクトは非同期なコードのリファクタリングの助けになるのでしょうか？ <a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-8.py">twisted-deferred/defer-8.py</a> にある例で考えてみましょう。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span>

<span class="k">def</span> <span class="nf">got_poem</span><span class="p">(</span><span class="n">poem</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">poem</span>
    <span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">poem_failed</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;poem download failed&#39;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;I am terribly sorry&#39;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;try again later?&#39;</span>
    <span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>

<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">got_poem</span><span class="p">,</span> <span class="n">poem_failed</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="n">reactor</span><span class="o">.</span><span class="n">callWhenRunning</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">,</span> <span class="s1">&#39;Another short poem.&#39;</span><span class="p">)</span>

<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>基本的には先に示した元々の例と一緒ですが、reactor を動かす追加のコードがあります。reactor が動き始めた後で遅延オブジェクトに命令を飛ばすために <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L766">callWhenRunning</a> を使っていることに注意してください。 <code class="docutils literal notranslate"><span class="pre">callWhenRunning</span></code> は、それが動作するときにコールバックへ渡すためのキーワード引数を追加で受け取る、ということを活用しています。コールバックを登録する多くの Twisted API は同じ習慣に従います。遅延オブジェクトにコールバックを追加する API も同様です。</p>
<p>コールバックとエラー用コールバックの両方が reactor を停止させます。遅延オブジェクトは正常系のコールバックとエラー用コールバックのチェーンをサポートしていますので、一般的なコードをチェーンの二つ目のリンクにリファクタリングできます。 <a class="reference external" href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-9.py">twisted-deferred/defer-9.py</a> で紹介するテクニックです。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span>

<span class="k">def</span> <span class="nf">got_poem</span><span class="p">(</span><span class="n">poem</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">poem</span>

<span class="k">def</span> <span class="nf">poem_failed</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;poem download failed&#39;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;I am terribly sorry&#39;</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;try again later?&#39;</span>

<span class="k">def</span> <span class="nf">poem_done</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>

<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">got_poem</span><span class="p">,</span> <span class="n">poem_failed</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">addBoth</span><span class="p">(</span><span class="n">poem_done</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="n">reactor</span><span class="o">.</span><span class="n">callWhenRunning</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">,</span> <span class="s1">&#39;Another short poem.&#39;</span><span class="p">)</span>

<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">addBoth</span></code> メソッドは同じ関数をコールバック・チェーンとエラー用コールバック・チェーンの両方に追加します。こうして非同期コードをリファクタリングできましたね。</p>
<blockquote>
<div><p><strong>ノート：</strong> この遅延オブジェクトがエラー用コールバック・チェーンを実行してしまうことがあります。
これについては先々のパートで議論しますが、とりあえず、遅延オブジェクトに関して学ぶべきことはたくさんある、と肝に命じておいてください。</p>
</div></blockquote>
</div>
<div class="section" id="id3">
<h2>まとめ<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>このパートでは、コールバックを使ったプログラミングを深堀りし、いくつかの潜在的な問題点を認識しました。また、 <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> クラスがどれほど私たちを助けてくれるかも見てきました。</p>
<ol class="arabic simple">
<li><p>エラー用コールバックは無視できません。全ての非同期な API で必須です。遅延オブジェクトにはこれへのサポートが組み込まれています。</p></li>
<li><p>コールバックを複数回呼び出すと、難解でデバッグが難しい問題を引き起こしやすくなります。</p></li>
<li><p>単純なコールバックを用いたプログラミングはリファクタリングをトリッキーにしてしまいます。遅延オブジェクトを使うと、コールバック・チェーンにリンクを追加し、あるリンクを他の場所に移動させることでリファクタリングできます。</p></li>
</ol>
<p>遅延オブジェクトにまつわる話題は尽きません。探求すべき原理と振る舞いはまだまだあります。しかし、詩のクライアントで使い始めるには十分といえるでしょう。”<a class="reference internal" href="p08.html"><span class="doc">パート8: Deferred で詩を</span></a>”でやってみましょう。</p>
</div>
<div class="section" id="id4">
<h2>おすすめの練習問題<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>最後の例では <code class="docutils literal notranslate"><span class="pre">poem_done</span></code> への引数を無視しています。出力させてみてください。 <code class="docutils literal notranslate"><span class="pre">get_poem</span></code> が値を返すようにすると、このことが <code class="docutils literal notranslate"><span class="pre">poem_done</span></code> への引数をどのように変えるかを考えてみてください。</p></li>
<li><p>最後のふたつの遅延オブジェクトを使った例を、エラー用コールバック・チェーンを実行するように修正してください。 <code class="docutils literal notranslate"><span class="pre">Exception</span></code> を引数としてエラー用コールバックを動かすようにしてくださいね。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Deferred</span></code> クラスの <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L189">addCallback</a> と <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L192">addErrback</a> メソッドの docstring を読んでください。</p></li>
</ol>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="p06.html">パート6: さらなる高みへ</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="p08.html">パート8: Deferred で詩を</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2010, Shigeru Kitazaki.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    </div>
  </body>
</html>